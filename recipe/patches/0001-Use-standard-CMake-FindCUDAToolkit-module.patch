From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Bradley Dice <bdice@bradleydice.com>
Date: Wed, 29 Jan 2025 12:00:00 -0800
Subject: [PATCH 1/2] Use standard CMake FindCUDAToolkit module

The custom FindCUDAToolkit.cmake does not work with conda-forge's
CUDA packages. Use the standard CMake module instead.

When CUDAToolkit_INCLUDE_DIR and CUDAToolkit_LIBRARY_DIR environment
variables are set, skip the nvcc search entirely by creating the
required imported targets manually. This supports building without
nvcc when using conda-forge's CUDA runtime packages.

---
 CMakeLists.txt | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 6c27cc5..5dad450 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,7 +5,6 @@
 cmake_minimum_required(VERSION 3.18)
 project(cuda-tile-python)
 
-list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_LIST_DIR}/cmake")
 
 if (MSVC)
     set(CMAKE_CXX_STANDARD 20)
@@ -66,7 +65,25 @@ endif()
 
 
 find_package(Python REQUIRED COMPONENTS Interpreter Development)
-find_package(CUDAToolkit REQUIRED)
+
+# Allow setting CUDAToolkit paths from environment variables to support
+# building without nvcc (e.g., conda-forge CUDA packages)
+if (DEFINED ENV{CUDAToolkit_INCLUDE_DIR} AND DEFINED ENV{CUDAToolkit_LIBRARY_DIR})
+    set(CUDAToolkit_INCLUDE_DIRS "$ENV{CUDAToolkit_INCLUDE_DIR}" CACHE PATH "CUDAToolkit include directories")
+    set(CUDAToolkit_LIBRARY_DIR "$ENV{CUDAToolkit_LIBRARY_DIR}" CACHE PATH "CUDAToolkit library directory")
+    set(CUDAToolkit_FOUND TRUE CACHE BOOL "CUDAToolkit found")
+    # Create the CUDA::cudart imported target that the build needs
+    if(NOT TARGET CUDA::cudart)
+        add_library(CUDA::cudart SHARED IMPORTED)
+        set_target_properties(CUDA::cudart PROPERTIES
+            IMPORTED_LOCATION "${CUDAToolkit_LIBRARY_DIR}/libcudart.so"
+            INTERFACE_INCLUDE_DIRECTORIES "${CUDAToolkit_INCLUDE_DIRS}"
+        )
+    endif()
+    message(STATUS "Using CUDAToolkit from environment: include=${CUDAToolkit_INCLUDE_DIRS}, lib=${CUDAToolkit_LIBRARY_DIR}")
+else()
+    find_package(CUDAToolkit REQUIRED)
+endif()
 
 add_custom_target(devinstall
     COMMAND ln -fs "${CMAKE_BINARY_DIR}/cext/lib_cext.so"
-- 
2.48.1
